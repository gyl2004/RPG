<!--åŠ¨æ€æ•…äº‹é¡µé¢-->
<view class="story-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="story-header">
    <text class="story-title">ğŸ­ æˆ‘çš„å†’é™©æ—¥è®°</text>
    <text class="story-subtitle">åŸºäºä½ çš„çœŸå®è¡Œä¸ºç”Ÿæˆçš„RPGæ•…äº‹</text>
  </view>

  <!-- è§’è‰²çŠ¶æ€æ  -->
  <view class="character-status">
    <view class="character-info">
      <text class="character-name">{{character.name}}</text>
      <text class="character-level">Lv.{{character.level}}</text>
    </view>
    <view class="story-stats">
      <text class="stat-item">ğŸ“– æ•…äº‹ç« èŠ‚: {{storyHistory.length}}</text>
      <text class="stat-item">â­ ä»Šæ—¥ä»»åŠ¡: {{todayActions.completedTasks.length}}</text>
    </view>
  </view>

  <!-- ç”Ÿæˆæ•…äº‹æŒ‰é’® -->
  <view class="action-section" wx:if="{{!currentStory}}">
    <rpg-button
      type="primary"
      text="{{generating ? 'æ­£åœ¨ç¼–ç»‡æ•…äº‹...' : 'ğŸ­ ç”Ÿæˆä»Šæ—¥å†’é™©æ•…äº‹'}}"
      size="large"
      bindtap="generateTodayStory"
      disabled="{{generating}}"
      loading="{{generating}}"
    />
    <text class="action-hint">åŸºäºä½ ä»Šå¤©çš„ä»»åŠ¡å®Œæˆæƒ…å†µå’Œæ”¶è—ç‰©å“ç”Ÿæˆä¸“å±æ•…äº‹</text>
  </view>

  <!-- å½“å‰æ•…äº‹æ˜¾ç¤º -->
  <view class="current-story" wx:if="{{currentStory}}">
    <view class="story-card">
      <view class="story-header-info">
        <text class="story-chapter-title">{{currentStory.title}}</text>
        <view class="story-meta">
          <text class="story-mood {{currentStory.mood}}">{{getMoodText(currentStory.mood)}}</text>
          <text class="story-time">{{formatTime(currentStory.createdAt)}}</text>
        </view>
      </view>
      
      <view class="story-content">
        <text class="story-text">{{currentStory.content}}</text>
      </view>

      <!-- å¥–åŠ±æ˜¾ç¤º -->
      <view class="story-rewards" wx:if="{{currentStory.rewards}}">
        <text class="rewards-title">ğŸ å†’é™©æ”¶è·</text>
        <view class="rewards-list">
          <text class="reward-item" wx:if="{{currentStory.rewards.experience}}">
            â­ ç»éªŒå€¼ +{{currentStory.rewards.experience}}
          </text>
          <text class="reward-item" wx:for="{{currentStory.rewards.items}}" wx:key="*this">
            ğŸ’ è·å¾—ç‰©å“: {{item}}
          </text>
          <text class="reward-item" wx:for="{{currentStory.rewards.skills}}" wx:key="*this">
            ğŸ’ª æŠ€èƒ½æå‡: {{item}}
          </text>
        </view>
      </view>

      <!-- é€‰æ‹©åˆ†æ”¯ -->
      <view class="story-choices" wx:if="{{currentStory.choices && currentStory.choices.length > 0}}">
        <text class="choices-title">ğŸ”® ä½ çš„é€‰æ‹©å°†å†³å®šæ•…äº‹çš„èµ°å‘</text>
        <view class="choices-list">
          <view
            class="choice-item"
            wx:for="{{currentStory.choices}}"
            wx:key="id"
            data-choice="{{item}}"
            bindtap="makeChoice"
          >
            <view class="choice-content">
              <text class="choice-text">{{item.text}}</text>
              <text class="choice-consequence">{{item.consequence}}</text>
            </view>
            <view class="choice-arrow">â†’</view>
          </view>
        </view>
      </view>

      <!-- ä¸‹ä¸€ç« æç¤º -->
      <view class="next-hints" wx:if="{{currentStory.nextHints}}">
        <text class="hints-title">ğŸ” ä¸‹ç« é¢„å‘Š</text>
        <text class="hints-text">{{currentStory.nextHints}}</text>
      </view>
    </view>

    <!-- æ•…äº‹æ“ä½œæŒ‰é’® -->
    <view class="story-actions">
      <rpg-button
        type="secondary"
        text="ğŸ“š æŸ¥çœ‹æ•…äº‹å†å²"
        size="medium"
        bindtap="showStoryHistory"
      />
      <rpg-button
        type="accent"
        text="ğŸ”„ é‡æ–°ç”Ÿæˆæ•…äº‹"
        size="medium"
        bindtap="generateTodayStory"
        disabled="{{generating}}"
      />

    </view>
  </view>

  <!-- æ•…äº‹å†å²æ¨¡æ€æ¡† -->
  <view class="modal-overlay" wx:if="{{showHistoryModal}}" bindtap="closeHistoryModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ğŸ“š å†’é™©å†å²</text>
        <view class="modal-close" bindtap="closeHistoryModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="history-list">
          <view
            class="history-item"
            wx:for="{{storyHistory}}"
            wx:key="id"
            data-story="{{item}}"
            bindtap="selectHistoryStory"
          >
            <view class="history-header">
              <text class="history-title">{{item.title}}</text>
              <text class="history-date">{{formatDate(item.createdAt)}}</text>
            </view>
            <text class="history-preview">{{item.content.substring(0, 100)}}...</text>
            <view class="history-meta">
              <text class="history-mood {{item.mood}}">{{getMoodText(item.mood)}}</text>
              <text class="history-type">{{item.type === 'ai_generated' ? 'ğŸ¤– AIç”Ÿæˆ' : 'ğŸ² å¤‡é€‰'}}</text>
            </view>
          </view>
        </view>
        
        <view class="empty-history" wx:if="{{storyHistory.length === 0}}">
          <text class="empty-text">è¿˜æ²¡æœ‰å†’é™©æ•…äº‹ï¼Œå¿«å»å®Œæˆä¸€äº›ä»»åŠ¡æ¥å¼€å¯ä½ çš„ä¼ å¥‡å§ï¼</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ•°æ®æ¥æºæ˜¾ç¤º -->
  <view class="data-source">
    <view class="source-toggle" bindtap="toggleDataSource">
      <text class="toggle-text">ğŸ“Š {{showDataSource ? 'æ”¶èµ·' : 'æŸ¥çœ‹'}} æ•…äº‹æ•°æ®æ¥æº</text>
    </view>
    <view class="source-content" wx:if="{{showDataSource}}">
      <text class="source-item">âœ… ä»Šæ—¥å®Œæˆä»»åŠ¡: {{todayActions.completedTasks.length}}ä¸ª</text>
      <text class="source-item">ğŸ”„ ä»Šæ—¥å®Œæˆä¹ æƒ¯: {{todayActions.completedHabits.length}}ä¸ª</text>
      <text class="source-item">ğŸ’ æ”¶è—ç‰©å“: {{collectedItems.length}}ä¸ª</text>
      <text class="source-item">â­ è§’è‰²ç­‰çº§: {{character.level}}</text>
    </view>
  </view>
</view>
