<!--è§’è‰²é¡µé¢-->
<view class="character-container">
  <!-- è§’è‰²å¤´éƒ¨ä¿¡æ¯ -->
  <view class="character-header">
    <view class="character-info">
      <view class="character-basic">
        <text class="character-name">{{character.name || user.nickname}}</text>
        <text class="character-title">{{characterTitle}}</text>
        <text class="character-class">{{character.class}}</text>
        <text class="character-level">Lv.{{character.level || 1}}</text>
      </view>

      <!-- ç»éªŒå€¼æ¡ -->
      <view class="exp-section">
        <view class="exp-header">
          <text class="exp-label">ç»éªŒå€¼</text>
          <text class="exp-remaining">è¿˜éœ€ {{expToNextLevel}} ç»éªŒå‡çº§</text>
        </view>
        <view class="exp-bar">
          <view class="exp-progress" style="width: {{expProgress}}%"></view>
        </view>
        <text class="exp-text">{{expProgress}}% ({{character.experience || 0}}/{{character.level >= 100 ? 'MAX' : expToNextLevel + (character.experience || 0)}})</text>
      </view>

      <!-- ç­‰çº§æ®µå’Œæˆ˜æ–—åŠ› -->
      <view class="stats-row">
        <view class="level-tier">
          <text class="tier-icon">{{levelTier.icon}}</text>
          <text class="tier-name" style="color: {{levelTier.color}}">{{levelTier.name}}æ®µä½</text>
        </view>
        <view class="power-section">
          <text class="power-label">æˆ˜æ–—åŠ›</text>
          <text class="power-value">{{powerLevel}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å±æ€§ç‚¹æç¤º -->
  <view class="points-notice" wx:if="{{availablePoints > 0}}">
    <text class="notice-icon">ğŸ¯</text>
    <text class="notice-text">ä½ æœ‰ {{availablePoints}} ä¸ªå±æ€§ç‚¹å¯ä»¥åˆ†é…</text>
  </view>

  <!-- å…­å¤§å±æ€§ -->
  <view class="attributes-section">
    <view class="section-header">
      <text class="section-title">è§’è‰²å±æ€§</text>
      <view wx:if="{{availablePoints > 0}}" class="points-display">
        <text class="points-text">å¯åˆ†é…: {{availablePoints}}</text>
        <rpg-button
          type="tertiary"
          text="{{allocatingMode ? 'å®Œæˆåˆ†é…' : 'åˆ†é…å±æ€§'}}"
          size="small"
          bindtap="toggleAllocatingMode"
        />
      </view>
    </view>

    <view class="attributes-grid">
      <view
        class="attribute-item {{allocatingMode ? 'allocating' : ''}}"
        wx:for="{{attributesList}}"
        wx:key="id"
        data-attribute="{{item.id}}"
        bindtap="{{allocatingMode ? '' : 'showAttributeDetail'}}"
      >
        <view class="attribute-header">
          <text class="attribute-icon">{{item.icon}}</text>
          <text class="attribute-name">{{item.name}}</text>
          <text class="attribute-level">
            {{item.value >= 80 ? 'Sçº§' :
              item.value >= 60 ? 'Açº§' :
              item.value >= 40 ? 'Bçº§' :
              item.value >= 20 ? 'Cçº§' : 'Dçº§'}}
          </text>
        </view>

        <view class="attribute-value">
          <text class="value-number">{{item.value}}</text>
          <view class="value-bar">
            <view
              class="value-progress"
              style="width: {{item.value > 100 ? 100 : item.value}}%; background-color: {{item.color}}"
            ></view>
          </view>
        </view>

        <!-- åˆ†é…æ¨¡å¼ä¸‹çš„æ“ä½œæŒ‰é’® -->
        <view wx:if="{{allocatingMode}}" class="allocation-controls">
          <view
            class="allocation-btn decrease {{item.value <= 0 ? 'disabled' : ''}}"
            data-attribute="{{item.id}}"
            data-action="decrease"
            bindtap="adjustAttribute"
          >
            <text class="btn-text">-</text>
          </view>
          <text class="allocation-value">{{item.value}}</text>
          <view
            class="allocation-btn increase {{availablePoints <= 0 || item.value >= 100 ? 'disabled' : ''}}"
            data-attribute="{{item.id}}"
            data-action="increase"
            bindtap="adjustAttribute"
          >
            <text class="btn-text">+</text>
          </view>
        </view>

        <text class="attribute-description">{{item.description}}</text>
      </view>
    </view>

    <!-- åˆ†é…æ¨¡å¼ä¸‹çš„æ“ä½œæç¤º -->
    <view wx:if="{{allocatingMode}}" class="allocation-tips">
      <text class="tips-text">ğŸ’¡ ç‚¹å‡» + æˆ– - æŒ‰é’®æ¥åˆ†é…å±æ€§ç‚¹</text>
      <view class="allocation-actions">
        <rpg-button
          type="secondary"
          text="é‡ç½®åˆ†é…"
          size="small"
          bindtap="resetAllocation"
        />
        <rpg-button
          type="primary"
          text="ç¡®è®¤åˆ†é…"
          size="small"
          bindtap="confirmAllocation"
          disabled="{{availablePoints === originalAvailablePoints}}"
        />
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="actions-section">
    <view class="action-row">
      <rpg-button
        type="primary"
        text="æŸ¥çœ‹è¯¦æƒ…"
        bindtap="viewCharacterDetails"
      />
      <rpg-button
        type="secondary"
        text="å¤–è§‚å®šåˆ¶"
        bindtap="goToAppearance"
      />
    </view>

    <view class="action-row" wx:if="{{availablePoints === 0 && character.level > 1}}">
      <rpg-button
        type="warning"
        text="é‡ç½®å±æ€§"
        bindtap="resetAttributes"
      />
    </view>

    <view class="test-actions">
      <text class="test-label">æµ‹è¯•åŠŸèƒ½</text>
      <view class="test-buttons">
        <rpg-button
          type="accent"
          text="è·å¾—ç»éªŒ"
          size="small"
          bindtap="testGainExp"
        />
        <rpg-button
          type="accent"
          text="å®Œæˆä»»åŠ¡"
          size="small"
          bindtap="simulateTaskComplete"
        />
      </view>
    </view>
  </view>

  <!-- å±æ€§è¯¦æƒ…æ¨¡æ€æ¡† -->
  <view class="modal-overlay" wx:if="{{showAttributeModal}}" bindtap="closeAttributeModal">
    <view class="attribute-modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title">{{selectedAttribute.name}}</text>
        <text class="modal-icon">{{selectedAttribute.icon}}</text>
      </view>

      <view class="modal-content">
        <text class="attribute-description">{{selectedAttribute.description}}</text>

        <view class="current-value">
          <text class="value-label">å½“å‰æ•°å€¼</text>
          <text class="value-number">{{selectedAttribute.value}}/100</text>
        </view>

        <view class="value-bar-large">
          <view
            class="value-progress-large"
            style="width: {{selectedAttribute.value}}%; background-color: {{selectedAttribute.color}}"
          ></view>
        </view>

        <view class="attribute-effects">
          <text class="effects-title">å±æ€§æ•ˆæœ</text>
          <text class="effects-text">
            {{selectedAttribute.value >= 80 ? 'å¤§å¸ˆçº§ï¼šæ˜¾è‘—æå‡ç›¸å…³ä»»åŠ¡å¥–åŠ±' :
              selectedAttribute.value >= 60 ? 'ä¸“å®¶çº§ï¼šæ˜æ˜¾æå‡ç›¸å…³ä»»åŠ¡å¥–åŠ±' :
              selectedAttribute.value >= 40 ? 'ç†Ÿç»ƒçº§ï¼šé€‚åº¦æå‡ç›¸å…³ä»»åŠ¡å¥–åŠ±' :
              selectedAttribute.value >= 20 ? 'å…¥é—¨çº§ï¼šè½»å¾®æå‡ç›¸å…³ä»»åŠ¡å¥–åŠ±' : 'æ–°æ‰‹çº§ï¼šåŸºç¡€æ•ˆæœ'}}
          </text>
        </view>
      </view>

      <view class="modal-actions" wx:if="{{availablePoints > 0}}">
        <rpg-button
          type="primary"
          text="åˆ†é… 1 ç‚¹"
          size="small"
          data-attribute="{{selectedAttribute.id}}"
          data-points="1"
          bindtap="allocateAttribute"
        />
        <rpg-button
          type="secondary"
          text="åˆ†é… 5 ç‚¹"
          size="small"
          data-attribute="{{selectedAttribute.id}}"
          data-points="5"
          bindtap="allocateAttribute"
          wx:if="{{availablePoints >= 5}}"
        />
      </view>

      <view class="modal-close">
        <rpg-button
          type="secondary"
          text="å…³é—­"
          size="small"
          bindtap="closeAttributeModal"
        />
      </view>
    </view>
  </view>

  <!-- å‡çº§åŠ¨ç”»æ¨¡æ€æ¡† -->
  <level-up-modal
    show="{{showLevelUpModal}}"
    levelUpData="{{levelUpData}}"
    bindclose="closeLevelUpModal"
    bindshare="shareLevelUp"
  />

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-overlay">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>
</view>
