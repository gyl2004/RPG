<!--ä»»åŠ¡è¯¦æƒ…é¡µé¢-->

<!-- æ·»åŠ è®°å½•æ¨¡æ€æ¡† -->
<view class="modal-overlay" wx:if="{{showRecordModal}}" bindtap="closeRecordModal">
  <view class="record-modal" catchtap="">
    <view class="modal-header">
      <text class="modal-title">æ·»åŠ è®°å½•</text>
      <text class="modal-close" bindtap="closeRecordModal">âœ•</text>
    </view>

    <view class="record-types">
      <view
        class="record-type-item"
        data-type="photo"
        bindtap="selectRecordType"
      >
        <text class="type-icon">ğŸ“·</text>
        <view class="type-info">
          <text class="type-name">æ‹ç…§è®°å½•</text>
          <text class="type-desc">è®°å½•å½“å‰è¿›å±•çš„ç…§ç‰‡</text>
        </view>
        <text class="type-arrow">â€º</text>
      </view>

      <view
        class="record-type-item"
        data-type="note"
        bindtap="selectRecordType"
      >
        <text class="type-icon">ğŸ“</text>
        <view class="type-info">
          <text class="type-name">æ–‡å­—è®°å½•</text>
          <text class="type-desc">å†™ä¸‹å½“å‰çš„æ„Ÿæƒ³å’Œè¿›å±•</text>
        </view>
        <text class="type-arrow">â€º</text>
      </view>

      <view
        class="record-type-item"
        data-type="progress"
        bindtap="selectRecordType"
      >
        <text class="type-icon">ğŸ“ˆ</text>
        <view class="type-info">
          <text class="type-name">è¿›åº¦èŠ‚ç‚¹</text>
          <text class="type-desc">è®°å½•å½“å‰è¿›åº¦é‡Œç¨‹ç¢‘</text>
        </view>
        <text class="type-arrow">â€º</text>
      </view>
    </view>
  </view>
</view>

<view class="task-detail-container" wx:if="{{task}}">
  <!-- ä»»åŠ¡å¤´éƒ¨ä¿¡æ¯ -->
  <view class="task-header">
    <view class="task-title-section">
      <text class="task-title">{{task.title}}</text>
      <view class="task-status {{task.status}}">
        <text class="status-icon">{{taskStatuses[task.status].icon}}</text>
        <text class="status-text">{{taskStatuses[task.status].name}}</text>
      </view>
    </view>
    
    <text class="task-description" wx:if="{{task.description}}">{{task.description}}</text>
  </view>

  <!-- ä»»åŠ¡ä¿¡æ¯å¡ç‰‡ -->
  <view class="task-info-card">
    <view class="info-row">
      <view class="info-item">
        <text class="info-icon">{{categories[task.category].icon}}</text>
        <view class="info-content">
          <text class="info-label">åˆ†ç±»</text>
          <text class="info-value">{{categories[task.category].name}}</text>
        </view>
      </view>
      
      <view class="info-item">
        <text class="info-icon">{{difficulties[task.difficulty].icon}}</text>
        <view class="info-content">
          <text class="info-label">éš¾åº¦</text>
          <text class="info-value">{{difficulties[task.difficulty].name}}</text>
        </view>
      </view>
    </view>

    <view class="info-row">
      <view class="info-item">
        <text class="info-icon">â°</text>
        <view class="info-content">
          <text class="info-label">é¢„ä¼°æ—¶é—´</text>
          <text class="info-value">{{task.estimatedTime}}åˆ†é’Ÿ</text>
        </view>
      </view>
      
      <view class="info-item" wx:if="{{verificationTypes && verificationTypes[task.verification]}}">
        <text class="info-icon">{{verificationTypes[task.verification].icon}}</text>
        <view class="info-content">
          <text class="info-label">è®°å½•æ–¹å¼</text>
          <text class="info-value">{{verificationTypes[task.verification].name}}</text>
        </view>
      </view>
    </view>

    <view class="info-row" wx:if="{{task.deadline}}">
      <view class="info-item full-width">
        <text class="info-icon">ğŸ“…</text>
        <view class="info-content">
          <text class="info-label">æˆªæ­¢æ—¥æœŸ</text>
          <text class="info-value">{{task.deadline}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ä»»åŠ¡è¿›åº¦ -->
  <view class="progress-section" wx:if="{{task.status === 'in_progress'}}">
    <view class="progress-header">
      <text class="section-title">ä»»åŠ¡è¿›åº¦</text>
      <rpg-button
        type="accent"
        text="æ·»åŠ è®°å½•"
        size="small"
        bindtap="showAddRecordModal"
      />
    </view>

    <view class="progress-container">
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{progress}}%"></view>
      </view>
      <text class="progress-text">{{progress}}%</text>
    </view>

    <view class="progress-controls">
      <slider
        class="progress-slider"
        min="0"
        max="100"
        step="5"
        value="{{progress}}"
        bindchange="onProgressChange"
        activeColor="#3b82f6"
        backgroundColor="rgba(255,255,255,0.2)"
      />
      <rpg-button
        type="secondary"
        text="ä¿å­˜è¿›åº¦"
        size="small"
        bindtap="saveProgress"
      />
    </view>
  </view>

  <!-- ä»»åŠ¡å¥–åŠ± -->
  <view class="rewards-section" wx:if="{{task.rewards}}">
    <text class="section-title">å®Œæˆå¥–åŠ±</text>
    <view class="rewards-grid">
      <view class="reward-item">
        <text class="reward-icon">â­</text>
        <text class="reward-text">{{task.rewards.experience}} ç»éªŒå€¼</text>
      </view>
      <view class="reward-item">
        <text class="reward-icon">ğŸ’°</text>
        <text class="reward-text">{{task.rewards.coins}} é‡‘å¸</text>
      </view>
      <view class="reward-item" wx:if="{{task.rewards.attributeBonus}}">
        <text class="reward-icon">ğŸ“ˆ</text>
        <text class="reward-text">å±æ€§åŠ æˆ</text>
      </view>
    </view>
  </view>

  <!-- é˜¶æ®µæ€§è®°å½•æ—¶é—´è½´ -->
  <view class="timeline-section" wx:if="{{task.progressRecords && task.progressRecords.length > 0}}">
    <text class="section-title">è¿›å±•è®°å½•</text>

    <view class="timeline-container">
      <view
        class="timeline-item"
        wx:for="{{task.progressRecords}}"
        wx:key="id"
        wx:for-item="record"
      >
        <!-- æ—¶é—´è½´çº¿æ¡å’ŒèŠ‚ç‚¹ -->
        <view class="timeline-line">
          <view class="timeline-dot {{record.type}}"></view>
          <view class="timeline-connector" wx:if="{{index < task.progressRecords.length - 1}}"></view>
        </view>

        <!-- è®°å½•å†…å®¹ -->
        <view class="timeline-content">
          <view class="record-header">
            <text class="record-title">{{record.data.title}}</text>
            <text class="record-time">{{formatTime(record.timestamp)}}</text>
            <text class="record-progress">{{record.progress}}%</text>
          </view>

          <!-- ç…§ç‰‡è®°å½• -->
          <view class="photo-record" wx:if="{{record.type === 'photo'}}">
            <image
              src="{{record.data.imagePath}}"
              class="timeline-image"
              mode="aspectFill"
              bindtap="previewImage"
              data-src="{{record.data.imagePath}}"
            />
            <text class="record-desc">{{record.data.description}}</text>
          </view>

          <!-- æ–‡å­—è®°å½• -->
          <view class="note-record" wx:if="{{record.type === 'note'}}">
            <view class="note-content">
              <text class="note-text">{{record.data.noteText}}</text>
            </view>
          </view>

          <!-- è¿›åº¦è®°å½• -->
          <view class="progress-record" wx:if="{{record.type === 'progress'}}">
            <view class="progress-milestone">
              <text class="milestone-icon">ğŸ“ˆ</text>
              <text class="milestone-text">è¿›åº¦é‡Œç¨‹ç¢‘</text>
            </view>
          </view>

          <!-- åˆ é™¤æŒ‰é’® -->
          <view class="record-actions" wx:if="{{task.status === 'in_progress'}}">
            <text
              class="delete-record"
              data-record-id="{{record.id}}"
              bindtap="deleteProgressRecord"
            >
              åˆ é™¤
            </text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å®Œæˆè®°å½• -->
  <view class="record-section" wx:if="{{task.status === 'completed' && task.verificationData}}">
    <text class="section-title">å®Œæˆè®°å½•</text>

    <!-- ç…§ç‰‡è®°å½• -->
    <view class="photo-record" wx:if="{{task.verificationData.type === 'photo'}}">
      <image
        src="{{task.verificationData.data.imagePath}}"
        class="record-image"
        mode="aspectFill"
        bindtap="previewImage"
        data-src="{{task.verificationData.data.imagePath}}"
      />
      <text class="record-desc">{{task.verificationData.data.description}}</text>
      <text class="record-time">è®°å½•æ—¶é—´ï¼š{{task.verificationData.data.recordTime}}</text>
    </view>

    <!-- æ–‡å­—è®°å½• -->
    <view class="note-record" wx:if="{{task.verificationData.type === 'note'}}">
      <view class="note-content">
        <text class="note-text">{{task.verificationData.data.noteText}}</text>
      </view>
      <text class="record-desc">{{task.verificationData.data.description}}</text>
      <text class="record-time">è®°å½•æ—¶é—´ï¼š{{task.verificationData.data.recordTime}}</text>
    </view>
  </view>

  <!-- ä»»åŠ¡å¤‡æ³¨ -->
  <view class="notes-section" wx:if="{{task.notes}}">
    <text class="section-title">å¤‡æ³¨</text>
    <text class="notes-text">{{task.notes}}</text>
  </view>

  <!-- ä»»åŠ¡æ—¶é—´ä¿¡æ¯ -->
  <view class="time-info-section">
    <text class="section-title">æ—¶é—´ä¿¡æ¯</text>
    <view class="time-info-grid">
      <view class="time-item">
        <text class="time-label">åˆ›å»ºæ—¶é—´</text>
        <text class="time-value">{{task.createdAt}}</text>
      </view>
      <view class="time-item" wx:if="{{task.startedAt}}">
        <text class="time-label">å¼€å§‹æ—¶é—´</text>
        <text class="time-value">{{task.startedAt}}</text>
      </view>
      <view class="time-item" wx:if="{{task.completedAt}}">
        <text class="time-label">å®Œæˆæ—¶é—´</text>
        <text class="time-value">{{task.completedAt}}</text>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-buttons">
    <!-- å¾…å¼€å§‹çŠ¶æ€ -->
    <view wx:if="{{task.status === 'pending'}}" class="button-group">
      <rpg-button 
        type="primary" 
        text="å¼€å§‹ä»»åŠ¡" 
        bindtap="startTask"
      />
      <rpg-button 
        type="secondary" 
        text="å–æ¶ˆä»»åŠ¡" 
        bindtap="cancelTask"
      />
    </view>

    <!-- è¿›è¡Œä¸­çŠ¶æ€ -->
    <view wx:elif="{{task.status === 'in_progress'}}" class="button-group">
      <rpg-button 
        type="primary" 
        text="å®Œæˆä»»åŠ¡" 
        bindtap="completeTask"
      />
      <rpg-button 
        type="secondary" 
        text="å–æ¶ˆä»»åŠ¡" 
        bindtap="cancelTask"
      />
    </view>

    <!-- å·²å®ŒæˆçŠ¶æ€ -->
    <view wx:elif="{{task.status === 'completed'}}" class="button-group">
      <rpg-button 
        type="accent" 
        text="ä»»åŠ¡å·²å®Œæˆ" 
        disabled="true"
      />
      <rpg-button 
        type="secondary" 
        text="åˆ é™¤ä»»åŠ¡" 
        bindtap="deleteTask"
      />
    </view>

    <!-- å…¶ä»–çŠ¶æ€ -->
    <view wx:else class="button-group">
      <rpg-button 
        type="secondary" 
        text="åˆ é™¤ä»»åŠ¡" 
        bindtap="deleteTask"
      />
    </view>
  </view>



  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-overlay">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>
</view>

<!-- ä»»åŠ¡ä¸å­˜åœ¨ -->
<view class="empty-state" wx:else>
  <text class="empty-icon">âŒ</text>
  <text class="empty-title">ä»»åŠ¡ä¸å­˜åœ¨</text>
  <text class="empty-desc">è¯¥ä»»åŠ¡å¯èƒ½å·²è¢«åˆ é™¤æˆ–ä¸å­˜åœ¨</text>
  <rpg-button 
    type="primary" 
    text="è¿”å›ä»»åŠ¡åˆ—è¡¨" 
    bindtap="navigateBack"
  />
</view>
