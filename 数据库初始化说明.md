# 数据库初始化说明

## ⚠️ 重要：解决"集合不存在"错误

如果您遇到以下错误：
```
Error: errCode: -502005 database collection not exists
```

这表明云数据库中的集合（表）尚未创建。请按照以下步骤解决：

## 🚀 快速解决方案

### 方案一：使用云函数（推荐）

#### 1. 部署云函数
1. 在微信开发者工具中，右键点击 `cloudfunctions/initDatabase` 文件夹
2. 选择"上传并部署：云端安装依赖（不上传node_modules）"
3. 等待部署完成

#### 2. 初始化数据库
1. 打开小程序
2. 进入"🗄️ 数据库管理"页面
3. 点击"🔨 初始化所有集合"
4. 等待所有集合创建完成

### 方案二：手动创建集合

如果云函数部署失败，可以手动创建集合：

1. 登录微信云开发控制台：https://console.cloud.tencent.com/tcb
2. 进入您的云开发环境
3. 在"数据库"页面，手动创建以下集合：
   - `users` - 用户基本信息
   - `characters` - 角色数据和属性
   - `stories` - 动态故事记录
   - `tasks` - 任务完成记录
   - `habits` - 习惯坚持记录
   - `items` - 收藏物品数据

## 📋 详细步骤

### 云函数部署详情

#### 1. 确保云开发环境已开通
- 在微信开发者工具中，确保已开通云开发
- 记录云开发环境ID

#### 2. 部署initDatabase云函数
```bash
# 云函数文件结构
cloudfunctions/
└── initDatabase/
    ├── index.js      # 主要逻辑
    └── package.json  # 依赖配置
```

#### 3. 测试云函数
在云开发控制台中测试：
```json
{
  "action": "testConnection"
}
```

### 数据库初始化详情

#### 支持的操作
- `testConnection`: 测试数据库连接
- `checkCollections`: 检查所有集合状态
- `createAllCollections`: 创建所有必需集合
- `insertSampleData`: 插入示例数据
- `removeSampleData`: 删除示例数据

#### 创建的集合结构
```javascript
collections: {
  users: 'users',           // 用户基本信息
  characters: 'characters', // 角色数据和属性
  stories: 'stories',       // 动态故事记录
  tasks: 'tasks',          // 任务完成记录
  habits: 'habits',        // 习惯坚持记录
  items: 'items'           // 收藏物品数据
}
```

## 🔧 故障排除

### 常见问题

#### 1. 云函数部署失败
**症状**：上传云函数时报错
**解决**：
- 检查网络连接
- 确保云开发环境正常
- 重新部署云函数

#### 2. 权限错误
**症状**：调用云函数时权限不足
**解决**：
- 确保云函数已正确部署
- 检查云开发环境配置
- 确认用户已登录

#### 3. 集合创建失败
**症状**：初始化时部分集合创建失败
**解决**：
- 检查云函数日志
- 确认云开发环境有足够配额
- 手动创建失败的集合

### 调试方法

#### 1. 查看云函数日志
1. 登录云开发控制台
2. 进入"云函数"页面
3. 点击`initDatabase`函数
4. 查看"日志"选项卡

#### 2. 使用数据库管理页面
1. 打开"🗄️ 数据库管理"页面
2. 查看"操作日志"了解详细信息
3. 使用"🔍 检查数据库状态"验证结果

## ✅ 验证成功

初始化成功后，您应该看到：

### 数据库状态
```
数据库状态
├── 连接状态: ✅ 已连接
├── 集合总数: 6
├── 已存在: 6
└── 需创建: 0
```

### 集合列表
```
数据库集合
├── characters (角色数据和属性) ✅
├── stories (动态故事记录) ✅
├── items (收藏物品数据) ✅
├── tasks (任务完成记录) ✅
├── habits (习惯坚持记录) ✅
└── users (用户基本信息) ✅
```

## 🎯 完成后可用功能

初始化完成后，以下功能将正常工作：

- ✅ **角色数据云端同步**：角色信息自动备份到云端
- ✅ **动态故事生成**：AI生成的故事保存到云端
- ✅ **物品收藏管理**：收藏的物品云端备份
- ✅ **跨设备数据同步**：在不同设备间同步数据
- ✅ **任务和习惯记录**：完成记录云端保存

## 📞 技术支持

如果仍然遇到问题：

1. **检查云开发控制台**：查看详细错误日志
2. **重新初始化**：删除现有集合后重新创建
3. **联系开发者**：提供详细的错误信息

## 🔒 安全说明

- 所有数据都使用用户的openid进行隔离
- 示例数据标记为`_sample: true`，可安全删除
- 云函数只能操作当前用户的数据
- 敏感操作都在云端执行，确保安全性

---

**重要提醒**：首次使用应用时，请务必完成数据库初始化，否则会遇到"集合不存在"的错误。
