<!--æ•…äº‹çº¿å’Œä¸ªæ€§åŒ–é¡µé¢-->
<view class="story-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="story-header">
    <text class="page-title">æˆ‘çš„æ•…äº‹</text>
    <view class="progress-display">
      <text class="progress-text">è¿›åº¦ï¼š{{storyProgress.totalProgress || 0}}%</text>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{storyProgress.totalProgress || 0}}%"></view>
      </view>
    </view>
    <view class="service-status" wx:if="{{!loading}}">
      <text class="status-text">ğŸŸ¢ æœåŠ¡æ­£å¸¸</text>
    </view>
  </view>

  <!-- æ¯æ—¥ä¸ªæ€§åŒ–å†…å®¹ -->
  <view class="daily-content" wx:if="{{dailyContent.greeting}}">
    <view class="daily-card">
      <text class="daily-greeting">{{dailyContent.greeting}}</text>
      <text class="daily-motivation">{{dailyContent.motivation}}</text>
      <text class="story-update" wx:if="{{dailyContent.storyUpdate}}">{{dailyContent.storyUpdate}}</text>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tab-navigation">
    <scroll-view class="tab-scroll" scroll-x="true">
      <view class="tab-list">
        <view 
          class="tab-item {{currentTab === item.id ? 'active' : ''}}"
          wx:for="{{tabs}}"
          wx:key="id"
          data-tab="{{item.id}}"
          bindtap="switchTab"
        >
          <text class="tab-icon">{{item.icon}}</text>
          <text class="tab-text">{{item.name}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ•…äº‹çº¿é¡µé¢ -->
  <view class="tab-content" wx:if="{{currentTab === 'story'}}">
    <view class="story-section">
      <view class="section-header">
        <text class="section-title">æ•…äº‹ç« èŠ‚</text>
        <view class="header-buttons">
          <!-- æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢ -->
          <view class="mode-switcher">
            <view
              class="mode-btn {{storyDisplayMode === 'timeline' ? 'active' : ''}}"
              data-mode="timeline"
              bindtap="switchStoryMode"
            >
              <text class="mode-icon">ğŸ“‹</text>
            </view>
            <view
              class="mode-btn {{storyDisplayMode === 'book' ? 'active' : ''}}"
              data-mode="book"
              bindtap="switchStoryMode"
            >
              <text class="mode-icon">ğŸ“–</text>
            </view>
            <view
              class="mode-btn {{storyDisplayMode === 'card' ? 'active' : ''}}"
              data-mode="card"
              bindtap="switchStoryMode"
            >
              <text class="mode-icon">ğŸƒ</text>
            </view>
          </view>

          <rpg-button
            type="secondary"
            text="åˆ·æ–°æ•°æ®"
            size="small"
            bindtap="loadStoryData"
          />
          <rpg-button
            wx:if="{{canGenerateNewChapter()}}"
            type="primary"
            text="ç”Ÿæˆæ–°ç« èŠ‚"
            size="small"
            bindtap="showGenerateModal"
          />
        </view>
      </view>

      <!-- æ•…äº‹ä¹¦ç»„ä»¶ -->
      <story-book
        chapters="{{chaptersList}}"
        progress="{{storyProgress}}"
        mode="{{storyDisplayMode}}"
        show-progress="{{true}}"
        bind:chapterselect="onStoryBookChapterSelect"
      />
    </view>
  </view>

  <!-- ä¸ªæ€§åŒ–é¡µé¢ -->
  <view class="tab-content" wx:if="{{currentTab === 'profile'}}">
    <view class="profile-section">
      <text class="section-title">ä¸ªæ€§åŒ–è®¾ç½®</text>
      
      <!-- è§’è‰²ç±»å‹é€‰æ‹© -->
      <view class="setting-group">
        <view class="setting-header">
          <text class="setting-title">é€‰æ‹©ä½ çš„è§’è‰²ç±»å‹</text>
          <text class="setting-subtitle">ä¸åŒè§’è‰²ç±»å‹ä¼šå½±å“æ¨èå†…å®¹</text>
        </view>
        <view class="character-types">
          <view 
            class="character-card {{userProfile.characterType === type.id ? 'selected' : ''}}"
            wx:for="{{characterTypes}}"
            wx:key="id"
            wx:for-item="type"
            data-type="{{type.id}}"
            bindtap="updateCharacterType"
          >
            <text class="character-icon">{{type.icon}}</text>
            <text class="character-name">{{type.name}}</text>
            <text class="character-description">{{type.description}}</text>
          </view>
        </view>
      </view>

      <!-- æ´»è·ƒæ—¶é—´åå¥½ -->
      <view class="setting-group">
        <view class="setting-header">
          <text class="setting-title">ä½ çš„æ´»è·ƒæ—¶é—´</text>
          <text class="setting-subtitle">å¸®åŠ©æˆ‘ä»¬ä¸ºä½ æ¨èåˆé€‚çš„ä»»åŠ¡æ—¶é—´</text>
        </view>
        <view class="time-preferences">
          <view 
            class="time-option {{userProfile.preferences.activeTime === 'morning' ? 'selected' : ''}}"
            data-time="morning"
            bindtap="updateActiveTime"
          >
            <text class="time-icon">ğŸŒ…</text>
            <text class="time-label">æ—©æ™¨å‹</text>
          </view>
          <view 
            class="time-option {{userProfile.preferences.activeTime === 'afternoon' ? 'selected' : ''}}"
            data-time="afternoon"
            bindtap="updateActiveTime"
          >
            <text class="time-icon">â˜€ï¸</text>
            <text class="time-label">ä¸‹åˆå‹</text>
          </view>
          <view 
            class="time-option {{userProfile.preferences.activeTime === 'night' ? 'selected' : ''}}"
            data-time="night"
            bindtap="updateActiveTime"
          >
            <text class="time-icon">ğŸŒ™</text>
            <text class="time-label">å¤œæ™šå‹</text>
          </view>
        </view>
      </view>

      <!-- å½“å‰è®¾ç½®æ¦‚è§ˆ -->
      <view class="current-profile">
        <text class="profile-title">å½“å‰è®¾ç½®</text>
        <view class="profile-info">
          <view class="info-item">
            <text class="info-label">è§’è‰²ç±»å‹ï¼š</text>
            <text class="info-value">{{characterTypes[userProfile.characterType].name}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">æ´»è·ƒæ—¶é—´ï¼š</text>
            <text class="info-value">
              {{userProfile.preferences.activeTime === 'morning' ? 'æ—©æ™¨å‹' : 
                userProfile.preferences.activeTime === 'afternoon' ? 'ä¸‹åˆå‹' : 'å¤œæ™šå‹'}}
            </text>
          </view>
        </view>
      </view>
    </view>
  </view>






  <!-- ç« èŠ‚è¯¦æƒ…æ¨¡æ€æ¡† -->
  <view class="modal-overlay" wx:if="{{showChapterModal}}" bindtap="hideChapterModal">
    <view class="chapter-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{selectedChapter.title}}</text>
        <view class="modal-close" bindtap="hideChapterModal">
          <text class="close-icon">âœ•</text>
        </view>
      </view>
      <view class="modal-content">
        <view class="chapter-story">
          <text class="story-content">{{selectedChapter.content}}</text>
        </view>
        <view class="chapter-info" wx:if="{{selectedChapter.rewards}}">
          <text class="info-title">ç« èŠ‚å¥–åŠ±</text>
          <view class="rewards-display">
            <text class="reward-item" wx:if="{{selectedChapter.rewards.coins}}">
              ğŸ’° {{selectedChapter.rewards.coins}} é‡‘å¸
            </text>
            <text class="reward-item" wx:if="{{selectedChapter.rewards.experience}}">
              â­ {{selectedChapter.rewards.experience}} ç»éªŒ
            </text>
          </view>
        </view>
      </view>
      <view class="modal-actions" wx:if="{{getChapterStatus(selectedChapter) === 'unlocked'}}">
        <rpg-button 
          type="primary" 
          text="å®Œæˆç« èŠ‚" 
          bindtap="completeChapter"
        />
      </view>
    </view>
  </view>

  <!-- æ´»åŠ¨é¡µé¢ -->
  <view class="tab-content" wx:if="{{currentTab === 'events'}}">
    <view class="events-section">
      <text class="section-title">å­£èŠ‚æ€§æ´»åŠ¨ä¸éšæœºäº‹ä»¶</text>

      <!-- å½“å‰å­£èŠ‚ -->
      <view class="season-info" wx:if="{{seasonalEvents.currentSeason}}">
        <view class="season-header">
          <text class="season-title">å½“å‰å­£èŠ‚ï¼š{{seasonalEvents.currentSeason === 'spring' ? 'æ˜¥å­£ğŸŒ¸' : seasonalEvents.currentSeason === 'summer' ? 'å¤å­£â˜€ï¸' : seasonalEvents.currentSeason === 'autumn' ? 'ç§‹å­£ğŸ‚' : 'å†¬å­£â„ï¸'}}</text>
        </view>
      </view>

      <!-- æ´»è·ƒçš„å­£èŠ‚æ€§æ´»åŠ¨ -->
      <view class="active-events" wx:if="{{seasonalEvents.activeEvents && seasonalEvents.activeEvents.length > 0}}">
        <text class="subsection-title">è¿›è¡Œä¸­çš„å­£èŠ‚æ´»åŠ¨</text>
        <view class="events-list">
          <view
            class="event-card seasonal-event"
            wx:for="{{seasonalEvents.activeEvents}}"
            wx:key="id"
            wx:for-item="event"
          >
            <view class="event-header">
              <text class="event-icon">{{event.icon}}</text>
              <view class="event-info">
                <text class="event-name">{{event.name}}</text>
                <text class="event-description">{{event.description}}</text>
              </view>
            </view>
            <view class="event-details">
              <text class="event-bonus">å¥–åŠ±åŠ æˆï¼š{{event.bonusValue}}x</text>
              <text class="event-remaining">å‰©ä½™ï¼š{{event.remainingDays}}å¤©</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å³å°†åˆ°æ¥çš„æ´»åŠ¨ -->
      <view class="upcoming-events" wx:if="{{seasonalEvents.upcomingEvents && seasonalEvents.upcomingEvents.length > 0}}">
        <text class="subsection-title">å³å°†åˆ°æ¥çš„æ´»åŠ¨</text>
        <view class="events-list">
          <view
            class="event-card upcoming-event"
            wx:for="{{seasonalEvents.upcomingEvents}}"
            wx:key="id"
            wx:for-item="event"
            data-event-id="{{event.id}}"
            bindtap="activateSeasonalEvent"
          >
            <view class="event-header">
              <text class="event-icon">{{event.icon}}</text>
              <view class="event-info">
                <text class="event-name">{{event.name}}</text>
                <text class="event-description">{{event.description}}</text>
              </view>
            </view>
            <view class="event-actions">
              <text class="activate-hint">ç‚¹å‡»æ¿€æ´»</text>
            </view>
          </view>
        </view>
      </view>

      <!-- éšæœºäº‹ä»¶ -->
      <view class="random-events" wx:if="{{randomEvents.length > 0}}">
        <text class="subsection-title">éšæœºäº‹ä»¶</text>
        <view class="events-list">
          <view
            class="event-card random-event {{event.rarity}}"
            wx:for="{{randomEvents}}"
            wx:key="id"
            wx:for-item="event"
            data-event-id="{{event.id}}"
            bindtap="completeRandomEvent"
          >
            <view class="event-header">
              <text class="event-icon">{{event.icon}}</text>
              <view class="event-info">
                <text class="event-name">{{event.name}}</text>
                <text class="event-description">{{event.description}}</text>
                <text wx:if="{{event.personalizedReason}}" class="event-reason">ğŸ’¡ {{event.personalizedReason}}</text>
              </view>
              <view class="event-badges">
                <view wx:if="{{event.isAIGenerated}}" class="ai-badge">
                  <text class="ai-badge-text">AI</text>
                </view>
                <view class="rarity-badge {{event.rarity}}">
                  <text class="rarity-text">{{event.rarity === 'common' ? 'æ™®é€š' : event.rarity === 'uncommon' ? 'ç¨€æœ‰' : event.rarity === 'rare' ? 'ç¨€æœ‰' : 'ä¼ è¯´'}}</text>
                </view>
              </view>
            </view>
            <view class="event-rewards" wx:if="{{event.effects}}">
              <text class="rewards-label">å¥–åŠ±ï¼š</text>
              <text class="reward-item" wx:if="{{event.effects.coins}}">{{event.effects.coins}}é‡‘å¸</text>
              <text class="reward-item" wx:if="{{event.effects.experience}}">{{event.effects.experience}}ç»éªŒ</text>
            </view>
          </view>
        </view>
      </view>

      <!-- ç”Ÿæˆéšæœºäº‹ä»¶æŒ‰é’® -->
      <view class="generate-event-section">
        <view class="event-buttons">
          <rpg-button
            type="primary"
            text="ğŸ¤– AIæ™ºèƒ½äº‹ä»¶"
            size="small"
            bindtap="generateAIRandomEvent"
          />
          <rpg-button
            type="secondary"
            text="ğŸ² ä¼ ç»Ÿéšæœºäº‹ä»¶"
            size="small"
            bindtap="generateRandomEvent"
          />
        </view>
        <text class="generate-hint">æ¯å¤©æœ‰æœºä¼šé‡åˆ°æ„å¤–çš„æƒŠå–œï¼AIä¼šæ ¹æ®ä½ çš„çŠ¶æ€ç”Ÿæˆä¸ªæ€§åŒ–äº‹ä»¶ã€‚</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-events" wx:if="{{(!seasonalEvents.activeEvents || seasonalEvents.activeEvents.length === 0) && randomEvents.length === 0}}">
        <text class="empty-icon">ğŸ‰</text>
        <text class="empty-text">æš‚æ— æ´»åŠ¨äº‹ä»¶</text>
        <text class="empty-hint">ç»§ç»­ä½ çš„æˆé•¿ä¹‹æ—…ï¼Œæ›´å¤šç²¾å½©æ´»åŠ¨ç­‰å¾…ä½ å‘ç°ï¼</text>
      </view>
    </view>
  </view>

  <!-- æˆé•¿é¡µé¢ -->
  <view class="tab-content" wx:if="{{currentTab === 'growth'}}">
    <view class="growth-section">
      <text class="section-title">è§’è‰²æˆé•¿è¿½è¸ª</text>

      <!-- æƒ…æ„ŸçŠ¶æ€ -->
      <view class="emotional-state" wx:if="{{emotionalState.metrics}}">
        <text class="subsection-title">å½“å‰æƒ…æ„ŸçŠ¶æ€</text>
        <view class="emotion-primary">
          <text class="emotion-label">ä¸»è¦æƒ…æ„Ÿï¼š</text>
          <text class="emotion-value">{{emotionalState.primaryEmotion === 'joyful' ? 'ğŸ˜Š å¿«ä¹' : emotionalState.primaryEmotion === 'energetic' ? 'âš¡ å……æ»¡æ´»åŠ›' : emotionalState.primaryEmotion === 'confident' ? 'ğŸ’ª è‡ªä¿¡' : emotionalState.primaryEmotion === 'stressed' ? 'ğŸ˜° æœ‰å‹åŠ›' : emotionalState.primaryEmotion === 'sad' ? 'ğŸ˜¢ ä½è½' : emotionalState.primaryEmotion === 'unmotivated' ? 'ğŸ˜´ ç¼ºä¹åŠ¨åŠ›' : 'ğŸ˜Œ å¹³è¡¡'}}</text>
        </view>
        <view class="emotion-metrics">
          <view class="metric-item">
            <text class="metric-label">å¹¸ç¦åº¦</text>
            <view class="metric-bar">
              <view class="metric-fill" style="width: {{emotionalState.metrics.happiness}}%; background-color: {{getEmotionColor(emotionalState.metrics.happiness)}}"></view>
            </view>
            <text class="metric-value">{{formatEmotionValue(emotionalState.metrics.happiness)}}</text>
          </view>
          <view class="metric-item">
            <text class="metric-label">åŠ¨åŠ›å€¼</text>
            <view class="metric-bar">
              <view class="metric-fill" style="width: {{emotionalState.metrics.motivation}}%; background-color: {{getEmotionColor(emotionalState.metrics.motivation)}}"></view>
            </view>
            <text class="metric-value">{{formatEmotionValue(emotionalState.metrics.motivation)}}</text>
          </view>
          <view class="metric-item">
            <text class="metric-label">è‡ªä¿¡åº¦</text>
            <view class="metric-bar">
              <view class="metric-fill" style="width: {{emotionalState.metrics.confidence}}%; background-color: {{getEmotionColor(emotionalState.metrics.confidence)}}"></view>
            </view>
            <text class="metric-value">{{formatEmotionValue(emotionalState.metrics.confidence)}}</text>
          </view>
        </view>
        <view class="emotion-advice" wx:if="{{emotionalState.advice}}">
          <text class="advice-title">ğŸ’¡ æƒ…æ„Ÿå»ºè®®</text>
          <text class="advice-content">{{emotionalState.advice}}</text>
        </view>
      </view>

      <!-- è§’è‰²æˆé•¿æŒ‡æ ‡ -->
      <view class="character-growth" wx:if="{{characterGrowth.growthMetrics}}">
        <text class="subsection-title">è§’è‰²æˆé•¿æŒ‡æ ‡</text>
        <view class="growth-overview">
          <text class="growth-progress">æ€»ä½“è¿›åº¦ï¼š{{characterGrowth.overallProgress}}%</text>
          <text class="next-milestone">ä¸‹ä¸€é‡Œç¨‹ç¢‘ï¼š{{characterGrowth.nextMilestone.name}}</text>
        </view>
        <view class="growth-metrics">
          <view class="growth-item">
            <text class="growth-label">ğŸ’ª åŠ›é‡</text>
            <view class="growth-bar">
              <view class="growth-fill" style="width: {{characterGrowth.growthMetrics.strength}}%"></view>
            </view>
            <text class="growth-value">{{characterGrowth.growthMetrics.strength}}</text>
          </view>
          <view class="growth-item">
            <text class="growth-label">ğŸ§  æ™ºæ…§</text>
            <view class="growth-bar">
              <view class="growth-fill" style="width: {{characterGrowth.growthMetrics.wisdom}}%"></view>
            </view>
            <text class="growth-value">{{characterGrowth.growthMetrics.wisdom}}</text>
          </view>
          <view class="growth-item">
            <text class="growth-label">ğŸ¨ åˆ›é€ åŠ›</text>
            <view class="growth-bar">
              <view class="growth-fill" style="width: {{characterGrowth.growthMetrics.creativity}}%"></view>
            </view>
            <text class="growth-value">{{characterGrowth.growthMetrics.creativity}}</text>
          </view>
          <view class="growth-item">
            <text class="growth-label">ğŸ‘¥ ç¤¾äº¤</text>
            <view class="growth-bar">
              <view class="growth-fill" style="width: {{characterGrowth.growthMetrics.social}}%"></view>
            </view>
            <text class="growth-value">{{characterGrowth.growthMetrics.social}}</text>
          </view>
          <view class="growth-item">
            <text class="growth-label">ğŸ¯ è‡ªå¾‹</text>
            <view class="growth-bar">
              <view class="growth-fill" style="width: {{characterGrowth.growthMetrics.discipline}}%"></view>
            </view>
            <text class="growth-value">{{characterGrowth.growthMetrics.discipline}}</text>
          </view>
        </view>
        <view class="growth-advice" wx:if="{{characterGrowth.growthAdvice}}">
          <text class="advice-title">ğŸŒŸ æˆé•¿å»ºè®®</text>
          <view class="advice-list">
            <text
              class="advice-item"
              wx:for="{{characterGrowth.growthAdvice}}"
              wx:key="*this"
            >â€¢ {{item}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç”Ÿæˆç« èŠ‚æ¨¡æ€æ¡† -->
  <view class="modal-overlay" wx:if="{{showGenerateModal}}" bindtap="hideGenerateModal">
    <view class="generate-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ç”Ÿæˆä¸ªæ€§åŒ–ç« èŠ‚</text>
        <view class="modal-close" bindtap="hideGenerateModal">
          <text class="close-icon">âœ•</text>
        </view>
      </view>
      <view class="modal-content">
        <view class="generate-info">
          <text class="info-title">âœ¨ ä¸ªæ€§åŒ–æ•…äº‹ç”Ÿæˆ</text>
          <text class="info-description">
            ç³»ç»Ÿå°†æ ¹æ®ä½ çš„æˆé•¿å†ç¨‹ã€è§’è‰²ç±»å‹å’Œä¸ªäººæˆå°±ï¼Œä¸ºä½ é‡èº«å®šåˆ¶ä¸€ä¸ªç‹¬ç‰¹çš„æ•…äº‹ç« èŠ‚ã€‚
          </text>
          <view class="info-features">
            <view class="feature-item">
              <text class="feature-icon">ğŸ“–</text>
              <text class="feature-text">åŸºäºä½ çš„çœŸå®æˆå°±åˆ›ä½œ</text>
            </view>
            <view class="feature-item">
              <text class="feature-icon">ğŸ­</text>
              <text class="feature-text">ç¬¦åˆä½ çš„è§’è‰²ç±»å‹ç‰¹ç‚¹</text>
            </view>
            <view class="feature-item">
              <text class="feature-icon">ğŸ†</text>
              <text class="feature-text">åŒ…å«ä¸“å±å¥–åŠ±å’Œè®¤å¯</text>
            </view>
          </view>
        </view>
      </view>
      <view class="modal-actions">
        <rpg-button
          type="secondary"
          text="å–æ¶ˆ"
          bindtap="hideGenerateModal"
        />
        <rpg-button
          type="primary"
          text="ç”Ÿæˆç« èŠ‚"
          bindtap="generateNewChapter"
        />
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>
